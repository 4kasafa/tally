const crypto=require("crypto");const BASE32_ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";function base32Decode(s){s=String(s).replace(/=+$/,"").toUpperCase().replace(/[^A-Z2-7]/g,"");let bits=0;let value=0n;const bytes=[];for(const ch of s){const idx=BigInt(BASE32_ALPHABET.indexOf(ch));if(idx<0)throw new Error("Invalid base32 string");value=value<<5n|idx;bits+=5;if(bits>=8){bits-=8;const b=Number(value>>BigInt(bits)&0xffn);bytes.push(b)}}return Buffer.from(bytes)}function base32Encode(buf){let bits=0;let value=0;let out="";for(const byte of buf){value=value<<8|byte;bits+=8;while(bits>=5){bits-=5;out+=BASE32_ALPHABET[value>>bits&31]}}if(bits>0){out+=BASE32_ALPHABET[value<<5-bits&31]}return out}function digestToPassword(buf,length=8,charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){const out=[];const L=charset.length;let seed=Buffer.from(buf);let i=0;while(out.length<length){if(i>=seed.length){seed=crypto.createHash("sha256").update(seed).digest();i=0}const a=seed[i];const b=i+1<seed.length?seed[i+1]:0;const idx=((a<<8|b)>>>0)%L;out.push(charset[idx]);i+=2}return out.join("")}function generatePassword(secretBase32,options={}){const{length=8,charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",algorithm="sha256",stepSeconds=60,timeMs=Date.now()}=options;const key=base32Decode(secretBase32);const counter=BigInt(Math.floor(timeMs/1e3/stepSeconds));const counterBuf=Buffer.alloc(8);counterBuf.writeBigUInt64BE(counter,0);const hmac=crypto.createHmac(algorithm,key);hmac.update(counterBuf);const digest=hmac.digest();return digestToPassword(digest,length,charset)}function verifyPassword(secretBase32,candidate,options={}){const{length=8,charset="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",algorithm="sha256",stepSeconds=60,window=1,timeMs=Date.now()}=options;const baseCounter=Math.floor(timeMs/1e3/stepSeconds);for(let d=-window;d<=window;d++){const tMs=(baseCounter+d)*stepSeconds*1e3;const pw=generatePassword(secretBase32,{length:length,charset:charset,algorithm:algorithm,stepSeconds:stepSeconds,timeMs:tMs});if(pw===candidate)return true}return false}module.exports={generatePassword:generatePassword,verifyPassword:verifyPassword,base32Encode:base32Encode,base32Decode:base32Decode};